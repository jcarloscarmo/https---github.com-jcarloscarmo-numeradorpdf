<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seletor de Arquivos</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 800px;
        }

        h1, h2, h3 {
            font-weight: 700;
            margin-bottom: 20px;
        }

        p {
            margin-bottom: 30px;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .button {
            background-color: #007bff;
            color: #fff;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        input[type="file"] {
            display: none;
        }

        #file-list {
            margin-top: 30px;
            text-align: left;
        }

        .customization-section {
            margin-top: 40px;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 700;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input[type="color"] {
            padding: 5px;
            height: 40px;
        }

        .illustration-section {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            align-items: center;
        }

        .position-controls {
            flex: 1;
        }

        .document-preview {
            flex: 2;
            position: relative;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            height: 250px;
        }

        .stamp {
            position: absolute;
            padding: 5px;
            border: 1px solid red;
            white-space: nowrap;
        }

        .top-left { top: 10px; left: 10px; }
        .top-center { top: 10px; left: 50%; transform: translateX(-50%); }
        .top-right { top: 10px; right: 10px; }
        .bottom-left { bottom: 10px; left: 10px; }
        .bottom-center { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .bottom-right { bottom: 10px; right: 10px; }

        .actions-section {
            margin-top: 40px;
            border-top: 1px solid #eee;
            padding-top: 30px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Numerador de Arquivos PDF</h1>
        <h2>Seletor de Arquivos</h2>
        <p>Escolha selecionar um único arquivo, vários arquivos ou uma pasta inteira.</p>
        <div class="button-group">
            <button class="button" onclick="document.getElementById('single-file').click()">Selecionar um Arquivo</button>
            <button class="button" onclick="document.getElementById('multiple-files').click()">Selecionar Vários Arquivos</button>
            <button class="button" onclick="document.getElementById('folder').click()">Selecionar uma Pasta</button>
        </div>
        <input type="file" id="single-file" accept=".pdf">
        <input type="file" id="multiple-files" multiple accept=".pdf">
        <input type="file" id="folder" webkitdirectory directory>
        <div id="file-list"></div>

        <div class="customization-section">
            <h2>Personalização da Numeração Bates</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="prefix">Prefixo</label>
                    <input type="text" id="prefix" value="Doc- ">
                </div>
                <div class="form-group">
                    <label for="start-number">Nº Inicial</label>
                    <input type="number" id="start-number" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="digits">Nº de Dígitos</label>
                    <input type="number" id="digits" value="3" min="1">
                </div>
            </div>
            <div class="form-grid">
                 <div class="form-group">
                    <label for="font-size">Tamanho Fonte</label>
                    <input type="number" id="font-size" value="12" min="1">
                </div>
                <div class="form-group">
                    <label for="font-weight">Peso Fonte</label>
                    <select id="font-weight">
                        <option value="normal">Normal</option>
                        <option value="bold">Negrito</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="font-color">Cor Fonte</label>
                    <input type="color" id="font-color" value="#000000">
                </div>
                <div class="form-group">
                    <label for="bg-color">Cor Fundo</label>
                    <input type="color" id="bg-color" value="#ffffff">
                </div>
            </div>

            <h3>Posição e Visualização do Carimbo</h3>
            <div class="illustration-section">
                <div class="position-controls">
                    <div class="form-group">
                        <label><input type="radio" name="position" value="top-left" checked> Sup. Esquerdo</label>
                        <label><input type="radio" name="position" value="top-center"> Sup. Central</label>
                        <label><input type="radio" name="position" value="top-right"> Sup. Direito</label>
                        <label><input type="radio" name="position" value="bottom-left"> Inf. Esquerdo</label>
                        <label><input type="radio" name="position" value="bottom-center"> Inf. Central</label>
                        <label><input type="radio" name="position" value="bottom-right"> Inf. Direito</label>
                    </div>
                </div>
                <div class="document-preview">
                    <div id="stamp-preview" class="stamp top-left">CASE-000001</div>
                </div>
            </div>
        </div>

        <div class="actions-section">
            <h2>Executar e Baixar</h2>
            <div class="form-group">
                <label for="zip-name">Nome do arquivo ZIP de saída</label>
                <input type="text" id="zip-name" value="arquivos_numerados">
            </div>
            <div class="button-group">
                <button id="generate-btn" class="button">Gerar e Baixar Arquivos</button>
            </div>
            <p id="status-message"></p>
        </div>
    </div>

    <script>
        const { PDFDocument, rgb, StandardFonts } = PDFLib;

        // --- DOM Elements ---
        const singleFileInput = document.getElementById('single-file');
        const multipleFilesInput = document.getElementById('multiple-files');
        const folderInput = document.getElementById('folder');
        const fileList = document.getElementById('file-list');
        const stampPreview = document.getElementById('stamp-preview');
        const generateBtn = document.getElementById('generate-btn');
        const statusMessage = document.getElementById('status-message');

        // --- Form Inputs ---
        const prefixInput = document.getElementById('prefix');
        const startNumberInput = document.getElementById('start-number');
        const digitsInput = document.getElementById('digits');
        const fontSizeInput = document.getElementById('font-size');
        const fontWeightSelect = document.getElementById('font-weight');
        const fontColorInput = document.getElementById('font-color');
        const bgColorInput = document.getElementById('bg-color');
        const positionRadios = document.querySelectorAll('input[name="position"]');
        const zipNameInput = document.getElementById('zip-name');

        let selectedFiles = [];

        // --- Event Listeners ---
        singleFileInput.addEventListener('change', handleFileSelect);
        multipleFilesInput.addEventListener('change', handleFileSelect);
        folderInput.addEventListener('change', handleFileSelect);

        [prefixInput, startNumberInput, digitsInput, fontSizeInput, fontWeightSelect, fontColorInput, bgColorInput].forEach(el => {
            el.addEventListener('input', updateStampPreview);
        });
        positionRadios.forEach(radio => radio.addEventListener('change', updateStampPreview));

        generateBtn.addEventListener('click', generateAndDownloadFiles);

        // --- Functions ---
        function handleFileSelect(event) {
            selectedFiles = Array.from(event.target.files);
            displayFiles(selectedFiles);
            statusMessage.textContent = '';
        }

        function displayFiles(files) {
            fileList.innerHTML = '';
            if (files.length > 0) {
                const h3 = document.createElement('h3');
                h3.textContent = 'Arquivos Selecionados:';
                fileList.appendChild(h3);
                const ul = document.createElement('ul');
                for (const file of files) {
                    const li = document.createElement('li');
                    li.textContent = file.name;
                    ul.appendChild(li);
                }
                fileList.appendChild(ul);
            }
        }

        function updateStampPreview() {
            // Update Text
            const prefix = prefixInput.value;
            const startNumber = startNumberInput.value;
            const digits = parseInt(digitsInput.value, 10);
            if (isNaN(digits)) return;
            const paddedNumber = startNumber.padStart(digits, '0');
            stampPreview.textContent = prefix + paddedNumber;

            // Update Style
            stampPreview.style.fontSize = `${fontSizeInput.value}px`;
            stampPreview.style.fontWeight = fontWeightSelect.value;
            stampPreview.style.color = fontColorInput.value;
            stampPreview.style.backgroundColor = bgColorInput.value;

            // Update Position
            const selectedPosition = document.querySelector('input[name="position"]:checked').value;
            stampPreview.className = 'stamp ' + selectedPosition;
        }

        async function generateAndDownloadFiles() {
            if (selectedFiles.length === 0) {
                alert('Por favor, selecione um ou mais arquivos PDF primeiro.');
                return;
            }

            const zipName = zipNameInput.value.trim();
            if (!zipName) {
                alert('Por favor, insira um nome para o arquivo ZIP.');
                return;
            }

            generateBtn.disabled = true;
            statusMessage.textContent = 'Iniciando processo...';

            const zip = new JSZip();
            let batesCounter = parseInt(startNumberInput.value, 10);

            try {
                for (const file of selectedFiles) {
                    statusMessage.textContent = `Processando ${file.name}...`;
                    const existingPdfBytes = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(existingPdfBytes);
                    const font = await pdfDoc.embedFont(fontWeightSelect.value === 'bold' ? StandardFonts.HelveticaBold : StandardFonts.Helvetica);

                    const pages = pdfDoc.getPages();
                    for (let i = 0; i < pages.length; i++) {
                        const page = pages[i];
                        const { width, height } = page.getSize();
                        const batesNumber = `${prefixInput.value}${String(batesCounter).padStart(parseInt(digitsInput.value, 10), '0')}`;
                        
                        const textWidth = font.widthOfTextAtSize(batesNumber, parseInt(fontSizeInput.value, 10));
                        const textHeight = font.heightAtSize(parseInt(fontSizeInput.value, 10));
                        const padding = 5;

                        const position = document.querySelector('input[name="position"]:checked').value;
                        let x, y;

                        // Position calculations
                        if (position.includes('left')) x = padding;
                        if (position.includes('center')) x = width / 2 - textWidth / 2;
                        if (position.includes('right')) x = width - textWidth - padding;
                        if (position.includes('top')) y = height - textHeight - padding;
                        if (position.includes('bottom')) y = padding;

                        // Draw background rectangle
                        page.drawRectangle({
                            x: x - padding,
                            y: y - padding / 2,
                            width: textWidth + (padding * 2),
                            height: textHeight + padding,
                            color: hexToRgb(bgColorInput.value),
                        });

                        // Draw text
                        page.drawText(batesNumber, {
                            x: x,
                            y: y,
                            font: font,
                            size: parseInt(fontSizeInput.value, 10),
                            color: hexToRgb(fontColorInput.value),
                        });

                        batesCounter++;
                    }

                    const pdfBytes = await pdfDoc.save();
                    zip.file(file.name, pdfBytes);
                }

                statusMessage.textContent = `Gerando arquivo ${zipName}.zip...`;
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${zipName}.zip`);
                statusMessage.textContent = 'Processo concluído com sucesso!';

            } catch (error) {
                console.error(error);
                statusMessage.textContent = 'Ocorreu um erro: ' + error.message;
            } finally {
                generateBtn.disabled = false;
            }
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return rgb(r, g, b);
        }

        // Initial call
        updateStampPreview();

    </script>
</body>
</html>